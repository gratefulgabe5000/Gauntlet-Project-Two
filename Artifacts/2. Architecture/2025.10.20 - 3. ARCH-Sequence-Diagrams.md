# MessageAI Sequence Diagrams

**Version:** 1.0  
**Date:** October 20, 2025  
**Project:** MessageAI - Key User Flow Sequences

---

## Table of Contents

1. [Authentication Flows](#authentication-flows)
2. [Messaging Flows](#messaging-flows)
3. [AI Feature Flows](#ai-feature-flows)
4. [Offline Scenarios](#offline-scenarios)
5. [Push Notification Flows](#push-notification-flows)

---

## Authentication Flows

### User Sign Up Flow

```mermaid
sequenceDiagram
    actor User
    participant UI as Sign Up Screen
    participant Auth as Auth Store
    participant Firebase as Firebase Auth
    participant Firestore as Cloud Firestore
    participant Storage as Cloud Storage
    
    User->>UI: Enter email & password
    User->>UI: Tap "Sign Up"
    
    UI->>Auth: signUp(email, password)
    Auth->>Firebase: createUserWithEmailAndPassword()
    
    alt Sign Up Success
        Firebase-->>Auth: User credentials
        Auth->>Auth: Set user in store
        
        Note over UI: Navigate to Profile Creation
        
        User->>UI: Enter display name
        User->>UI: Select profile picture
        UI->>Storage: Upload avatar
        Storage-->>UI: Avatar URL
        
        UI->>Firestore: Create user document
        Firestore-->>UI: Success
        
        UI->>User: Navigate to main app
        
    else Sign Up Failure
        Firebase-->>Auth: Error (email exists, weak password)
        Auth-->>UI: Show error
        UI->>User: Display error message
    end
```

### User Login Flow

```mermaid
sequenceDiagram
    actor User
    participant UI as Login Screen
    participant Auth as Auth Store
    participant Firebase as Firebase Auth
    participant Firestore as Cloud Firestore
    participant SQLite as Local DB
    
    User->>UI: Enter email & password
    User->>UI: Tap "Login"
    
    UI->>Auth: login(email, password)
    Auth->>Firebase: signInWithEmailAndPassword()
    
    alt Login Success
        Firebase-->>Auth: User credentials + ID token
        Auth->>Auth: Set user in store
        Auth->>Auth: Save token to AsyncStorage
        
        par Parallel Data Loading
            Auth->>Firestore: Fetch user profile
            and
            Auth->>SQLite: Load cached data
        end
        
        Firestore-->>Auth: User data
        SQLite-->>Auth: Cached conversations
        
        Auth->>Firestore: Update user status to 'online'
        Auth->>Firestore: Update lastSeen timestamp
        
        Auth-->>UI: Login complete
        UI->>User: Navigate to main app
        
    else Login Failure
        Firebase-->>Auth: Error (wrong credentials, user not found)
        Auth-->>UI: Show error
        UI->>User: Display error message
    end
```

### Google OAuth Flow

```mermaid
sequenceDiagram
    actor User
    participant UI as Login Screen
    participant Auth as Auth Store
    participant Expo as Expo Auth Session
    participant Google as Google OAuth
    participant Firebase as Firebase Auth
    participant Firestore as Cloud Firestore
    
    User->>UI: Tap "Sign in with Google"
    
    UI->>Auth: signInWithGoogle()
    Auth->>Expo: promptAsync()
    Expo->>Google: OAuth redirect
    
    Google->>User: Google login page
    User->>Google: Enter credentials & approve
    
    Google-->>Expo: Authorization code
    Expo-->>Auth: ID token
    
    Auth->>Firebase: signInWithCredential(googleCredential)
    
    alt First Time User
        Firebase-->>Auth: New user created
        Auth->>Firestore: Create user document with Google info
        Firestore-->>Auth: Success
        UI->>User: Navigate to profile setup (optional)
        
    else Existing User
        Firebase-->>Auth: Existing user credentials
        Auth->>Firestore: Update lastSeen
        UI->>User: Navigate to main app
    end
```

---

## Messaging Flows

### Send Message Flow (Optimistic UI)

```mermaid
sequenceDiagram
    actor User
    participant UI as Chat Screen
    participant Store as Message Store
    participant UUID as uuid Library
    participant SQLite as Local DB
    participant Firestore as Cloud Firestore
    participant FCM as Firebase Cloud Messaging
    participant Recipient as Recipient Device
    
    User->>UI: Type message & send
    
    UI->>UUID: Generate temp ID
    UUID-->>UI: tempId: "uuid-1234"
    
    Note over UI,Store: Optimistic Update
    
    UI->>Store: addOptimisticMessage(tempId, messageData)
    Store->>Store: Add to messages with status: 'sending'
    Store-->>UI: Update UI immediately
    UI->>User: Show message with gray checkmark
    
    par Parallel Operations
        Store->>SQLite: Cache message locally
        SQLite-->>Store: Cached
        
        and
        
        Store->>Firestore: Add message to conversation
        
        alt Success
            Firestore-->>Store: Server ID returned
            Store->>Store: Update tempId → serverId, status: 'sent'
            Store-->>UI: Update checkmark (single)
            
            Firestore->>FCM: Trigger push notification
            FCM->>Recipient: Send push
            
            Recipient->>Firestore: Mark as 'delivered'
            Firestore-->>Store: Real-time update
            Store-->>UI: Update checkmark (double gray)
            
            Recipient->>Recipient: User views message
            Recipient->>Firestore: Mark as 'read'
            Firestore-->>Store: Real-time update
            Store-->>UI: Update checkmark (double blue)
            
        else Failure (Network Error)
            Firestore-->>Store: Error response
            Store->>Store: status: 'failed'
            Store-->>UI: Show error icon
            
            Store->>SQLite: Add to offline queue
            Note over SQLite: Will retry when online
        end
    end
```

### Receive Message Flow

```mermaid
sequenceDiagram
    actor Sender as Sender Device
    participant Firestore as Cloud Firestore
    participant FCM as Firebase Cloud Messaging
    participant Device as User's Device
    participant Listener as Firestore Listener
    participant Store as Message Store
    participant UI as Chat Screen
    participant SQLite as Local DB
    
    Sender->>Firestore: Send message
    
    par Push Notification
        Firestore->>FCM: Trigger notification
        FCM->>Device: Push notification
        Device->>Device: Show notification
        
    and Real-time Update
        Firestore->>Listener: Message added event
        Listener->>Store: New message received
        
        Store->>SQLite: Cache message
        Store->>Store: Add to messages array
        Store-->>UI: Update UI
        
        alt User is viewing conversation
            UI->>UI: Scroll to new message
            UI->>UI: Play notification sound
            
            Store->>Firestore: Mark as 'read'
            Store->>Firestore: Update readBy array
            
        else User not viewing conversation
            Store->>Store: Increment unread count
            UI->>UI: Update badge count
        end
    end
```

### Group Message Flow

```mermaid
sequenceDiagram
    actor Sender
    participant UI as Chat Screen
    participant Store as Message Store
    participant Firestore as Cloud Firestore
    participant FCM as Firebase Cloud Messaging
    participant User2 as User 2 Device
    participant User3 as User 3 Device
    participant User4 as User 4 Device
    
    Sender->>UI: Send message to group
    UI->>Store: Send message
    Store->>Firestore: Add to conversation/messages
    
    Firestore-->>Store: Confirm delivery
    Store-->>UI: Update status: 'sent'
    
    par Notify all participants
        Firestore->>FCM: Trigger notification for User 2
        FCM->>User2: Push notification
        User2->>Firestore: Mark as 'delivered'
        
        and
        
        Firestore->>FCM: Trigger notification for User 3
        FCM->>User3: Push notification
        User3->>Firestore: Mark as 'delivered'
        
        and
        
        Firestore->>FCM: Trigger notification for User 4
        FCM->>User4: Push notification
        User4->>Firestore: Mark as 'delivered'
    end
    
    Note over Store: All delivered
    Firestore-->>Store: Update readBy array
    Store-->>UI: Show "Delivered to all"
    
    User2->>Firestore: Mark as 'read'
    User3->>Firestore: Mark as 'read'
    
    Firestore-->>Store: Real-time updates
    Store-->>UI: Show "Read by 2 of 3"
```

---

## AI Feature Flows

### Thread Summarization Flow

```mermaid
sequenceDiagram
    actor User
    participant UI as Chat Screen
    participant AIStore as AI Store
    participant Functions as Cloud Functions
    participant Firestore as Firestore
    participant OpenAI as OpenAI GPT-4
    
    User->>UI: Long-press conversation
    UI->>User: Show context menu
    User->>UI: Tap "Summarize Thread"
    
    UI->>AIStore: requestSummary(conversationId)
    AIStore->>UI: Show loading state
    
    AIStore->>Functions: POST /api/ai/summarize
    Note over Functions: { conversationId, lastReadMessageId }
    
    Functions->>Firestore: Fetch messages since last read
    Firestore-->>Functions: Return 50-100 messages
    
    Functions->>Functions: Format conversation context
    Functions->>OpenAI: Chat completion request
    Note over OpenAI: Prompt: "Summarize this conversation"
    
    OpenAI->>OpenAI: Generate summary
    OpenAI-->>Functions: Return summary
    
    Functions->>Firestore: Log AI interaction
    Functions-->>AIStore: Return summary
    
    AIStore->>UI: Display summary modal
    UI->>User: Show summary with key points
    
    alt User Action
        User->>UI: Tap "View Full Thread"
        UI->>User: Navigate to conversation
        
    or
        User->>UI: Tap "Mark as Read"
        UI->>Firestore: Update read receipts
        UI->>User: Dismiss modal
    end
```

### Action Item Extraction Flow

```mermaid
sequenceDiagram
    actor User
    participant UI as AI Assistant Screen
    participant AIStore as AI Store
    participant Functions as Cloud Functions
    participant Firestore as Firestore
    participant OpenAI as OpenAI GPT-4
    
    User->>UI: Open AI Assistant
    User->>UI: Tap "Extract Action Items"
    User->>UI: Select conversation(s)
    
    UI->>AIStore: extractActionItems(conversationIds)
    AIStore->>UI: Show loading
    
    AIStore->>Functions: POST /api/ai/extractActions
    
    Functions->>Firestore: Fetch recent messages (50 per conversation)
    Firestore-->>Functions: Return messages
    
    Functions->>Functions: Build structured prompt
    Functions->>OpenAI: Chat completion (JSON mode)
    Note over OpenAI: Prompt: "Extract action items<br/>Return as JSON"
    
    OpenAI->>OpenAI: Extract tasks, assignees, deadlines
    OpenAI-->>Functions: Return JSON array
    
    Functions->>Functions: Parse and validate JSON
    Functions->>Firestore: Log interaction
    Functions-->>AIStore: Return action items
    
    AIStore->>UI: Display action items list
    UI->>User: Show tasks with:
    Note over UI: - Task description<br/>- Assigned to<br/>- Due date<br/>- Priority
    
    alt User Actions
        User->>UI: Tap "Export to Calendar"
        UI->>Device: Create calendar events
        
    or
        User->>UI: Mark item as complete
        UI->>AIStore: Update local state
        
    or
        User->>UI: Jump to original message
        UI->>User: Navigate to conversation
    end
```

### Semantic Search Flow (RAG)

```mermaid
sequenceDiagram
    actor User
    participant UI as Search Screen
    participant AIStore as AI Store
    participant Functions as Cloud Functions
    participant OpenAI as OpenAI Embeddings
    participant Pinecone as Pinecone Vector DB
    participant Firestore as Firestore
    
    User->>UI: Enter search query
    Note over UI: "deployment discussions"
    
    UI->>AIStore: searchConversations(query)
    AIStore->>UI: Show loading
    
    AIStore->>Functions: POST /api/ai/search
    
    Functions->>OpenAI: Generate embedding for query
    OpenAI-->>Functions: Return query vector
    
    Functions->>Pinecone: Vector similarity search
    Note over Pinecone: Search top 10 similar messages
    Pinecone-->>Functions: Return message IDs + scores
    
    Functions->>Firestore: Fetch full message context
    Firestore-->>Functions: Return message details
    
    Functions->>Functions: Rank results by relevance
    Functions-->>AIStore: Return search results
    
    AIStore->>UI: Display results grouped by conversation
    
    UI->>User: Show:
    Note over UI: - Message preview<br/>- Conversation name<br/>- Sender<br/>- Timestamp<br/>- Relevance score
    
    User->>UI: Tap result
    UI->>User: Navigate to message in conversation
    UI->>UI: Highlight searched message
```

### Multi-Step Agent Flow

```mermaid
sequenceDiagram
    actor User
    participant UI as AI Chat
    participant AIStore as AI Store
    participant Functions as Cloud Functions
    participant AI as AI SDK (Vercel)
    participant OpenAI as OpenAI GPT-4
    participant Firestore as Firestore
    
    User->>UI: "Plan a team offsite for next month"
    
    UI->>AIStore: triggerAgent(request)
    AIStore->>Functions: POST /api/ai/agent
    
    Functions->>AI: Initialize agent with tools
    Note over AI: Tools:<br/>- getTeamMembers<br/>- checkAvailability<br/>- suggestLocations<br/>- createPoll<br/>- sendMessage
    
    AI->>OpenAI: Analyze request
    OpenAI-->>AI: "Need to check team availability"
    
    AI->>Functions: Call tool: getTeamMembers(conversationId)
    Functions->>Firestore: Fetch participants
    Firestore-->>Functions: Return 8 team members
    Functions-->>AI: Return team list
    
    AI->>AIStore: Update progress
    AIStore->>UI: Show: "Found 8 team members..."
    
    AI->>OpenAI: Next step?
    OpenAI-->>AI: "Check availability for date range"
    
    AI->>Functions: Call tool: checkAvailability(members, dateRange)
    Functions->>Functions: Analyze calendar (simulated)
    Functions-->>AI: "March 15-17 works for 8/10"
    
    AI->>AIStore: Update progress
    AIStore->>UI: Show: "Checking availability..."
    
    AI->>OpenAI: Next step?
    OpenAI-->>AI: "Suggest meeting location"
    
    AI->>Functions: Call tool: suggestLocations(teamLocations)
    Functions->>Functions: Calculate optimal location
    Functions-->>AI: "Austin, TX is central"
    
    AI->>AIStore: Update progress
    AIStore->>UI: Show: "Suggesting location..."
    
    AI->>OpenAI: Next step?
    OpenAI-->>AI: "Create poll for final confirmation"
    
    AI->>Functions: Call tool: createPoll(question, options)
    Functions->>Firestore: Create poll document
    Functions-->>AI: Poll created
    
    AI->>AIStore: Update progress
    AIStore->>UI: Show: "Creating poll..."
    
    AI->>OpenAI: Generate final response
    OpenAI-->>AI: Comprehensive summary
    
    AI-->>Functions: Agent complete
    Functions->>Firestore: Log interaction
    Functions-->>AIStore: Return results
    
    AIStore->>UI: Display final summary
    UI->>User: Show:
    Note over UI: "I've analyzed your team's availability.<br/>March 15-17 works for 8 of 10 members.<br/>I suggest Austin, TX as the location.<br/>I've created a poll to confirm the date."
    
    UI->>User: Show poll link
```

---

## Offline Scenarios

### Send Message While Offline

```mermaid
sequenceDiagram
    actor User
    participant UI as Chat Screen
    participant NetInfo as Network Monitor
    participant Store as Message Store
    participant Queue as Offline Queue
    participant SQLite as Local DB
    participant Firestore as Cloud Firestore
    
    Note over User,Firestore: User is OFFLINE
    
    User->>UI: Send message
    UI->>NetInfo: Check connectivity
    NetInfo-->>UI: isConnected: false
    
    UI->>Store: addOptimisticMessage(tempId, message)
    Store->>Store: Add with status: 'sending'
    Store-->>UI: Show message immediately
    
    Store->>SQLite: Cache message
    Store->>Queue: Add to offline queue
    Queue->>Queue: Store with:
    Note over Queue: - retryCount: 0<br/>- nextRetryAt: null<br/>- priority: 0
    
    UI->>User: Show "offline" indicator
    
    Note over User,Firestore: User comes ONLINE
    
    NetInfo->>Store: Network state change (online)
    Store->>Queue: Process queue
    
    Queue->>Firestore: Attempt send message
    
    alt Success
        Firestore-->>Queue: Success (server ID)
        Queue->>Queue: Remove from queue
        Queue->>Store: Update message status
        Store-->>UI: Update UI (checkmark)
        
    else Failure
        Firestore-->>Queue: Error
        Queue->>Queue: Increment retryCount
        Queue->>Queue: Calculate next retry time
        Note over Queue: Exponential backoff:<br/>1s, 2s, 4s, 8s, 16s, 30s
        
        Queue->>Queue: Schedule retry
    end
```

### Background Sync After App Restart

```mermaid
sequenceDiagram
    actor User
    participant App as React Native App
    participant SQLite as Local DB
    participant Firestore as Cloud Firestore
    participant Store as Message Store
    participant UI as Chat Screen
    
    User->>App: Open app
    
    App->>SQLite: Load cached data
    SQLite-->>App: Return:
    Note over SQLite: - Conversations<br/>- Messages<br/>- User profile
    
    App->>Store: Hydrate stores
    Store-->>UI: Render UI immediately
    UI->>User: Show cached data (instant)
    
    par Parallel Sync
        App->>Firestore: Subscribe to conversations
        Firestore-->>App: Stream updates
        
        and
        
        App->>Firestore: Subscribe to messages
        Firestore-->>App: Stream new messages
        
        and
        
        App->>SQLite: Check offline queue
        SQLite-->>App: Return queued items
        App->>Firestore: Process queue
    end
    
    loop For each update
        Firestore->>Store: New/updated data
        Store->>SQLite: Update cache
        Store->>UI: Update UI
    end
    
    Note over UI: UI stays in sync with server
```

---

## Push Notification Flows

### Foreground Notification

```mermaid
sequenceDiagram
    actor Sender
    participant Firestore as Cloud Firestore
    participant FCM as Firebase Cloud Messaging
    participant Device as User's Device (Foreground)
    participant ExpoNotif as Expo Notifications
    participant UI as App UI
    participant Store as Message Store
    
    Sender->>Firestore: Send message
    Firestore->>FCM: Trigger notification
    
    FCM->>Device: Push to device
    Device->>ExpoNotif: Notification received
    
    ExpoNotif->>ExpoNotif: Check notification handler
    
    alt User in same conversation
        ExpoNotif->>ExpoNotif: shouldShowAlert: false
        ExpoNotif->>Store: Update message silently
        Store->>UI: Update chat UI
        
    else User in different screen
        ExpoNotif->>ExpoNotif: shouldShowAlert: true
        ExpoNotif->>Device: Show in-app notification
        Device->>Device: Play sound
        Device->>UI: Show banner
        
        UI->>User: Display notification
        User->>UI: Tap notification
        UI->>UI: Navigate to conversation
    end
```

### Background Notification

```mermaid
sequenceDiagram
    actor Sender
    participant Firestore as Cloud Firestore
    participant FCM as Firebase Cloud Messaging
    participant Device as User's Device (Background)
    participant OS as iOS/Android System
    participant App as React Native App
    
    Sender->>Firestore: Send message
    Firestore->>FCM: Trigger notification
    
    FCM->>Device: Push to device
    Device->>OS: Notification received
    
    OS->>OS: Display system notification
    OS->>User: Show notification banner
    OS->>OS: Update badge count
    
    User->>OS: Tap notification
    OS->>App: Launch app with notification data
    
    App->>App: Parse notification data
    Note over App: { conversationId, messageId }
    
    App->>App: Navigate to conversation
    App->>User: Show message in context
```

### App Killed Notification

```mermaid
sequenceDiagram
    actor Sender
    participant Firestore as Cloud Firestore
    participant FCM as Firebase Cloud Messaging
    participant Device as User's Device (App Killed)
    participant OS as iOS/Android System
    participant App as React Native App
    
    Note over Device: App is NOT running
    
    Sender->>Firestore: Send message
    Firestore->>FCM: Trigger notification
    
    FCM->>Device: Push to device
    Device->>OS: Notification received
    
    OS->>OS: Display system notification
    OS->>User: Show notification
    
    User->>OS: Tap notification
    OS->>App: Cold start app with notification
    
    App->>App: Initialize app
    App->>App: Parse initial notification
    
    par App Initialization
        App->>SQLite: Load cached data
        and
        App->>Firestore: Subscribe to real-time updates
    end
    
    App->>App: Navigate to conversation
    App->>User: Show message in context
```

---

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | Oct 20, 2025 | Initial sequence diagrams document |

---

**Status:** ✅ Sequence Diagrams Complete  
**Next Steps:** Architecture summary document

