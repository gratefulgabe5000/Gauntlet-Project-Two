# MessageAI System Architecture

**Version:** 1.0  
**Date:** October 20, 2025  
**Project:** MessageAI - AI-Enhanced Mobile Messaging Platform

---

## Table of Contents

1. [High-Level System Architecture](#high-level-system-architecture)
2. [Component Architecture](#component-architecture)
3. [Data Flow Architecture](#data-flow-architecture)
4. [Network Architecture](#network-architecture)
5. [Security Architecture](#security-architecture)

---

## High-Level System Architecture

### Overview

MessageAI follows a three-tier architecture with mobile client, Firebase backend, and AI services layer.

```mermaid
graph TB
    subgraph "Mobile Client Layer"
        A[React Native App<br/>Expo SDK 51]
        A1[UI Components<br/>React Native Paper]
        A2[State Management<br/>Zustand + React Query]
        A3[Local Storage<br/>SQLite + AsyncStorage]
        
        A --> A1
        A --> A2
        A --> A3
    end
    
    subgraph "Backend Services Layer - Firebase"
        B[Firebase Auth<br/>User Management]
        C[Cloud Firestore<br/>Real-time Database]
        D[Cloud Functions<br/>Serverless API]
        E[Cloud Storage<br/>Media Files]
        F[Cloud Messaging<br/>Push Notifications]
    end
    
    subgraph "AI Services Layer"
        G[OpenAI GPT-4-Turbo<br/>LLM Processing]
        H[Pinecone<br/>Vector Database]
        I[AI SDK by Vercel<br/>Agent Framework]
    end
    
    subgraph "External Services"
        J[Expo Services<br/>EAS Build + Notifications]
    end
    
    A1 -.->|Authentication| B
    A2 -.->|Real-time Sync| C
    A2 -.->|API Calls| D
    A3 -.->|Offline Cache| C
    A1 -.->|Media Upload| E
    A1 -.->|Receive Notifications| F
    
    D -.->|AI Requests| G
    D -.->|Vector Search| H
    D -.->|Agent Tools| I
    
    F -.->|Push Delivery| J
    
    B -.->|User Data| C
    D -.->|Read/Write| C
    D -.->|User Verification| B
    
    style A fill:#4285F4,stroke:#333,stroke-width:2px,color:#fff
    style B fill:#FBBC04,stroke:#333,stroke-width:2px
    style C fill:#FBBC04,stroke:#333,stroke-width:2px
    style D fill:#FBBC04,stroke:#333,stroke-width:2px
    style E fill:#FBBC04,stroke:#333,stroke-width:2px
    style F fill:#FBBC04,stroke:#333,stroke-width:2px
    style G fill:#10A37F,stroke:#333,stroke-width:2px,color:#fff
    style H fill:#10A37F,stroke:#333,stroke-width:2px,color:#fff
    style I fill:#10A37F,stroke:#333,stroke-width:2px,color:#fff
```

---

## Component Architecture

### React Native App Structure

```mermaid
graph TD
    subgraph "App Entry Point"
        ROOT[app/_layout.tsx<br/>Root Layout]
    end
    
    subgraph "Authentication Flow"
        AUTH_LAYOUT[app/auth/_layout.tsx]
        LOGIN[app/auth/login.tsx]
        SIGNUP[app/auth/signup.tsx]
        PROFILE[app/auth/create-profile.tsx]
    end
    
    subgraph "Main App Flow"
        TAB_LAYOUT[app/tabs/_layout.tsx<br/>Tab Navigator]
        CONV_LIST[app/tabs/conversations.tsx<br/>Conversations Screen]
        AI_CHAT[app/tabs/ai-assistant.tsx<br/>AI Assistant Screen]
        SETTINGS[app/tabs/settings.tsx<br/>Settings Screen]
        CONV_DETAIL[app/conversation/[id].tsx<br/>Chat Screen]
    end
    
    subgraph "Shared Components"
        MSG_BUBBLE[MessageBubble.tsx]
        MSG_LIST[MessageList.tsx]
        MSG_INPUT[MessageInput.tsx]
        CONV_CARD[ConversationCard.tsx]
        AI_INTERFACE[AIChatInterface.tsx]
    end
    
    subgraph "Services Layer"
        FIREBASE[Firebase Services]
        AI_SERVICES[AI Services]
        LOCAL_DB[Local Database]
    end
    
    subgraph "State Management"
        AUTH_STORE[authStore]
        CONV_STORE[conversationStore]
        MSG_STORE[messageStore]
        AI_STORE[aiStore]
    end
    
    ROOT --> AUTH_LAYOUT
    ROOT --> TAB_LAYOUT
    
    AUTH_LAYOUT --> LOGIN
    AUTH_LAYOUT --> SIGNUP
    AUTH_LAYOUT --> PROFILE
    
    TAB_LAYOUT --> CONV_LIST
    TAB_LAYOUT --> AI_CHAT
    TAB_LAYOUT --> SETTINGS
    
    CONV_LIST --> CONV_DETAIL
    
    CONV_DETAIL --> MSG_LIST
    CONV_DETAIL --> MSG_INPUT
    MSG_LIST --> MSG_BUBBLE
    
    AI_CHAT --> AI_INTERFACE
    
    LOGIN --> FIREBASE
    SIGNUP --> FIREBASE
    CONV_DETAIL --> FIREBASE
    CONV_DETAIL --> LOCAL_DB
    AI_INTERFACE --> AI_SERVICES
    
    FIREBASE --> AUTH_STORE
    FIREBASE --> CONV_STORE
    FIREBASE --> MSG_STORE
    AI_SERVICES --> AI_STORE
    
    style ROOT fill:#4285F4,stroke:#333,stroke-width:2px,color:#fff
    style TAB_LAYOUT fill:#4285F4,stroke:#333,stroke-width:2px,color:#fff
    style FIREBASE fill:#FBBC04,stroke:#333,stroke-width:2px
    style AI_SERVICES fill:#10A37F,stroke:#333,stroke-width:2px,color:#fff
```

---

## Data Flow Architecture

### Message Sending Flow (Optimistic UI)

```mermaid
sequenceDiagram
    participant User
    participant UI as React Native UI
    participant Store as Message Store<br/>(Zustand)
    participant SQLite as Local DB<br/>(SQLite)
    participant Firestore as Cloud Firestore
    participant FCM as Firebase Cloud<br/>Messaging
    participant Recipient as Recipient Device
    
    User->>UI: Type & Send Message
    UI->>Store: Generate temp ID (uuid)
    
    Note over Store: Optimistic Insert
    Store->>Store: Add message with<br/>status: 'sending'
    Store->>UI: Update UI immediately
    UI->>User: Show message (gray checkmark)
    
    par Parallel Operations
        Store->>SQLite: Save to local cache
        and
        Store->>Firestore: Send to server
    end
    
    alt Success Path
        Firestore-->>Store: Server ID returned
        Store->>Store: Update temp ID to server ID<br/>status: 'sent'
        Store->>UI: Update status (checkmark)
        
        Firestore->>FCM: Trigger push notification
        FCM->>Recipient: Deliver notification
        
        Recipient->>Firestore: Mark as 'delivered'
        Firestore-->>Store: Update status
        Store->>UI: Show double checkmark
        
        Recipient->>Firestore: Mark as 'read'
        Firestore-->>Store: Update status
        Store->>UI: Show blue double checkmark
    else Failure Path
        Firestore-->>Store: Error (network/server)
        Store->>Store: status: 'failed'
        Store->>UI: Show error icon
        Store->>SQLite: Add to offline queue
        
        Note over SQLite,Firestore: Retry when online
    end
```

### AI Feature Request Flow

```mermaid
sequenceDiagram
    participant User
    participant UI as AI Chat UI
    participant AIStore as AI Store
    participant Functions as Cloud Functions
    participant Firestore as Firestore<br/>(Message History)
    participant OpenAI as OpenAI GPT-4
    participant Pinecone as Pinecone<br/>(Vector DB)
    
    User->>UI: Request: "Summarize thread"
    UI->>AIStore: Dispatch action
    AIStore->>Functions: Call summarizeThread(conversationId)
    
    Functions->>Firestore: Fetch last 50 messages
    Firestore-->>Functions: Return messages
    
    Functions->>Functions: Format conversation context
    Functions->>OpenAI: Send prompt + context
    
    OpenAI->>OpenAI: Generate summary
    OpenAI-->>Functions: Return summary
    
    Functions->>Firestore: Store AI interaction log
    Functions-->>AIStore: Return summary
    
    AIStore->>UI: Update with summary
    UI->>User: Display summary
    
    Note over User,Pinecone: For Semantic Search
    
    User->>UI: Request: "Find deployment discussions"
    UI->>AIStore: Dispatch search action
    AIStore->>Functions: Call searchConversations(query)
    
    Functions->>OpenAI: Generate query embedding
    OpenAI-->>Functions: Return vector
    
    Functions->>Pinecone: Vector similarity search
    Pinecone-->>Functions: Return top 10 results
    
    Functions->>Firestore: Fetch full message context
    Firestore-->>Functions: Return messages
    
    Functions-->>AIStore: Return search results
    AIStore->>UI: Display results
    UI->>User: Show relevant messages
```

### Offline Queue Processing Flow

```mermaid
sequenceDiagram
    participant User
    participant App as React Native App
    participant NetInfo as NetInfo Monitor
    participant Queue as Offline Queue<br/>(SQLite)
    participant Store as Message Store
    participant Firestore as Cloud Firestore
    
    Note over User,Firestore: User Goes Offline
    
    User->>App: Send message
    App->>NetInfo: Check connectivity
    NetInfo-->>App: isConnected: false
    
    App->>Store: Add optimistic message
    Store->>Queue: Add to offline queue<br/>(priority, retryCount: 0)
    Store->>App: Show "sending" status
    
    Note over User,Firestore: User Comes Online
    
    NetInfo->>App: Network state change<br/>isConnected: true
    App->>Queue: Retrieve queued messages
    Queue-->>App: Return messages (sorted by priority)
    
    loop For each queued message
        App->>Firestore: Attempt send
        
        alt Success
            Firestore-->>App: Success (server ID)
            App->>Queue: Remove from queue
            App->>Store: Update status: 'sent'
        else Failure
            Firestore-->>App: Error
            App->>Queue: Increment retryCount
            
            alt retryCount < 5
                App->>Queue: Schedule retry with backoff
                Note over Queue: Exponential backoff:<br/>1s, 2s, 4s, 8s, 16s
            else retryCount >= 5
                App->>Queue: Mark as failed
                App->>Store: Update status: 'failed'
                App->>User: Show error notification
            end
        end
    end
```

---

## Network Architecture

### API Endpoints & Data Flow

```mermaid
graph LR
    subgraph "Mobile Client"
        A[React Native App]
    end
    
    subgraph "Firebase APIs"
        B[Firebase Auth API<br/>identitytoolkit.googleapis.com]
        C[Firestore API<br/>firestore.googleapis.com]
        D[Storage API<br/>storage.googleapis.com]
        E[FCM API<br/>fcm.googleapis.com]
    end
    
    subgraph "Cloud Functions Endpoints"
        F1[/api/ai/summarize]
        F2[/api/ai/extractActions]
        F3[/api/ai/search]
        F4[/api/ai/detectPriority]
        F5[/api/ai/trackDecisions]
        F6[/api/ai/agent]
    end
    
    subgraph "External APIs"
        G[OpenAI API<br/>api.openai.com]
        H[Pinecone API<br/>api.pinecone.io]
    end
    
    A -->|REST + WebSocket| B
    A -->|WebSocket| C
    A -->|REST| D
    A -->|REST| E
    A -->|HTTPS| F1
    A -->|HTTPS| F2
    A -->|HTTPS| F3
    A -->|HTTPS| F4
    A -->|HTTPS| F5
    A -->|HTTPS| F6
    
    F1 -->|HTTPS| G
    F2 -->|HTTPS| G
    F3 -->|HTTPS| G
    F3 -->|HTTPS| H
    F4 -->|HTTPS| G
    F5 -->|HTTPS| G
    F6 -->|HTTPS| G
    
    C -.->|Real-time Updates| A
    E -.->|Push Notifications| A
    
    style A fill:#4285F4,stroke:#333,stroke-width:2px,color:#fff
    style B fill:#FBBC04,stroke:#333,stroke-width:2px
    style C fill:#FBBC04,stroke:#333,stroke-width:2px
    style D fill:#FBBC04,stroke:#333,stroke-width:2px
    style E fill:#FBBC04,stroke:#333,stroke-width:2px
    style G fill:#10A37F,stroke:#333,stroke-width:2px,color:#fff
    style H fill:#10A37F,stroke:#333,stroke-width:2px,color:#fff
```

---

## Security Architecture

### Authentication & Authorization Flow

```mermaid
graph TD
    subgraph "Client Layer"
        A[React Native App]
        A1[Auth Screen]
        A2[Protected Screens]
    end
    
    subgraph "Firebase Auth"
        B[Email/Password Auth]
        C[Google OAuth]
        D[Auth State Listener]
    end
    
    subgraph "Firebase Security"
        E[Firestore Security Rules]
        F[Storage Security Rules]
        G[Functions Auth Middleware]
    end
    
    subgraph "Data Access"
        H[(Firestore)]
        I[(Cloud Storage)]
        J[Cloud Functions]
    end
    
    A1 -->|Sign Up/Login| B
    A1 -->|OAuth Flow| C
    B --> D
    C --> D
    D -->|ID Token| A2
    
    A2 -->|Request + Token| E
    A2 -->|Upload + Token| F
    A2 -->|API Call + Token| G
    
    E -->|Validate & Allow| H
    F -->|Validate & Allow| I
    G -->|Validate & Process| J
    
    E -.->|Reject if unauthorized| A2
    F -.->|Reject if unauthorized| A2
    G -.->|401 Unauthorized| A2
    
    style A fill:#4285F4,stroke:#333,stroke-width:2px,color:#fff
    style B fill:#FBBC04,stroke:#333,stroke-width:2px
    style C fill:#FBBC04,stroke:#333,stroke-width:2px
    style E fill:#EA4335,stroke:#333,stroke-width:2px,color:#fff
    style F fill:#EA4335,stroke:#333,stroke-width:2px,color:#fff
    style G fill:#EA4335,stroke:#333,stroke-width:2px,color:#fff
```

### Security Layers

```mermaid
graph TB
    subgraph "Layer 1: Network Security"
        A[HTTPS/TLS 1.3]
        B[Certificate Pinning<br/>Firebase SDK]
    end
    
    subgraph "Layer 2: Authentication"
        C[Firebase Auth Tokens<br/>JWT]
        D[Token Refresh<br/>Auto-renewal]
    end
    
    subgraph "Layer 3: Authorization"
        E[Firestore Rules<br/>Role-based access]
        F[Cloud Functions<br/>Token verification]
    end
    
    subgraph "Layer 4: Data Protection"
        G[Encryption at Rest<br/>Firebase default]
        H[Encryption in Transit<br/>TLS]
    end
    
    subgraph "Layer 5: Client Security"
        I[Local Data Encryption<br/>SQLite encrypted]
        J[Secure Storage<br/>KeyChain/KeyStore]
    end
    
    A --> C
    B --> C
    C --> E
    D --> F
    E --> G
    F --> H
    G --> I
    H --> J
    
    style A fill:#EA4335,stroke:#333,stroke-width:2px,color:#fff
    style C fill:#EA4335,stroke:#333,stroke-width:2px,color:#fff
    style E fill:#EA4335,stroke:#333,stroke-width:2px,color:#fff
    style G fill:#EA4335,stroke:#333,stroke-width:2px,color:#fff
    style I fill:#EA4335,stroke:#333,stroke-width:2px,color:#fff
```

---

## Architecture Principles

### 1. Separation of Concerns

- **UI Layer**: React Native components (presentation only)
- **Business Logic**: Custom hooks + Zustand stores
- **Data Layer**: Firebase services + SQLite
- **AI Layer**: Cloud Functions (isolated from client)

### 2. Offline-First Design

- Local SQLite cache for all messages
- Optimistic UI updates
- Offline queue with retry logic
- Background sync when connectivity returns

### 3. Real-Time by Default

- Firestore real-time listeners for messages
- WebSocket connections for presence
- Push notifications for background updates

### 4. Security by Design

- API keys never in client code
- Cloud Functions as secure gateway to AI services
- Firestore security rules enforce data access
- Token-based authentication for all requests

### 5. Scalability Considerations

- Message pagination (50 messages per page)
- Conversation list lazy loading
- Image compression before upload
- Vector database for semantic search
- Serverless functions for horizontal scaling

---

## Technology Stack Alignment

### Mobile Client

| Layer | Technology | Purpose |
|-------|-----------|---------|
| Framework | React Native 0.74 + Expo SDK 51 | Cross-platform mobile development |
| Language | TypeScript 5.0 | Type safety and developer experience |
| UI Components | React Native Paper | Material Design components |
| Navigation | Expo Router | File-based routing |
| State Management | Zustand + React Query | Client state + server cache |
| Local Storage | Expo SQLite + AsyncStorage | Offline persistence |

### Backend Services

| Service | Technology | Purpose |
|---------|-----------|---------|
| Database | Cloud Firestore | Real-time NoSQL database |
| Authentication | Firebase Auth | User management |
| Functions | Cloud Functions (Node.js 20) | Serverless API |
| Storage | Cloud Storage | Media file storage |
| Messaging | Firebase Cloud Messaging | Push notifications |

### AI Services

| Service | Technology | Purpose |
|---------|-----------|---------|
| LLM | OpenAI GPT-4-Turbo | Natural language processing |
| Vector DB | Pinecone | Semantic search |
| Agent Framework | AI SDK by Vercel | Tool calling and agents |
| Embeddings | OpenAI text-embedding-3-small | Vector generation |

---

## Deployment Architecture

```mermaid
graph TB
    subgraph "Development Environment"
        A[Local Development<br/>Expo Go]
        B[Firebase Emulators<br/>Local testing]
    end
    
    subgraph "Staging Environment"
        C[Expo EAS Build<br/>Development client]
        D[Firebase Project<br/>Staging instance]
    end
    
    subgraph "Production Environment"
        E[Expo EAS Build<br/>Production client]
        F[Firebase Project<br/>Production instance]
        G[TestFlight / APK<br/>Distribution]
    end
    
    A -->|Test & Iterate| B
    B -->|Ready for staging| C
    C -->|Test on real devices| D
    D -->|Validated| E
    E -->|Deploy| F
    F -->|Distribute| G
    
    style A fill:#4285F4,stroke:#333,stroke-width:2px,color:#fff
    style C fill:#4285F4,stroke:#333,stroke-width:2px,color:#fff
    style E fill:#4285F4,stroke:#333,stroke-width:2px,color:#fff
```

---

## Performance Considerations

### Client-Side Optimization

1. **Message Virtualization**: FlatList with `windowSize` optimization
2. **Image Lazy Loading**: Load images as they enter viewport
3. **Component Memoization**: React.memo for expensive components
4. **Debounced Updates**: Typing indicators, search queries
5. **Local Cache**: SQLite for instant message display

### Server-Side Optimization

1. **Cloud Functions**: Cold start mitigation (keep-alive)
2. **Firestore Indexes**: Composite indexes for complex queries
3. **CDN**: Firebase Hosting for static assets
4. **Rate Limiting**: Prevent abuse of AI endpoints
5. **Caching**: AI response cache for common queries

### Network Optimization

1. **Batch Operations**: Group Firestore writes
2. **Compression**: Image/video compression before upload
3. **WebSocket**: Persistent connections for real-time updates
4. **Retry Logic**: Exponential backoff for failed requests
5. **Prefetching**: Preload conversation data on app start

---

## Monitoring & Observability

### Key Metrics

1. **Performance Metrics**
   - Message send latency (<500ms target)
   - App launch time (<2s target)
   - Real-time sync delay (<100ms target)

2. **Reliability Metrics**
   - Message delivery rate (100% target)
   - Offline queue success rate (>99% target)
   - App crash rate (<1% target)

3. **AI Metrics**
   - AI response time (<3s target)
   - AI accuracy (>85% target)
   - Token usage and cost

4. **User Metrics**
   - Daily active users
   - Messages sent per user
   - AI features usage rate

---

## Version History

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | Oct 20, 2025 | Initial system architecture document |

---

**Status:** ✅ Architecture Defined  
**Next Steps:** Component diagrams, sequence diagrams, database schemas


